{
  "userInputs": [
    {
      "id": "content-url-input",
      "type": "input",
      "name": "Original Content URL",
      "description": "Enter the URL of the original content to translate",
      "placeholder": "https://dev-www.frevana.com/content/...",
      "required": true
    },
    {
      "id": "target-languages-input",
      "type": "keywords",
      "name": "Target Languages",
      "description": "Comma-separated language codes (e.g., zh, ja, es)",
      "placeholder": "zh, ja, es",
      "required": true
    }
  ],
  "workflows": [
    {
      "id": "setup",
      "nameV2": "Setup",
      "type": "script",
      "outputFormat": "text",
      "script": "module.exports = async function() {\n  const contentUrl = data['content-url-input'] || '';\n  const languagesStr = data['target-languages-input'] || '';\n  \n  if (!contentUrl || !languagesStr) throw new Error('URL and languages required');\n  \n  // Extract content ID from URL\n  const urlParts = contentUrl.split('/');\n  const lastPart = urlParts[urlParts.length - 1];\n  const contentId = lastPart.split('-').pop();\n  if (!contentId || contentId.length < 10) throw new Error('Invalid content ID');\n  \n  // Parse target languages\n  const languages = languagesStr.split(',').map(l => l.trim().toLowerCase()).filter(l => l);\n  if (languages.length === 0) throw new Error('No valid languages');\n  \n  console.log(`Content ID: ${contentId}`);\n  console.log(`Target languages: ${languages.join(', ')}`);\n  \n  // Step 1: Check which translations already exist\n  console.log('Checking existing translations...');\n  const versionsResp = await api.frevanaApi.request(\n    'GET',\n    `/s3/content/${contentId}/language-versions`\n  );\n  \n  let existingLanguages = [];\n  if (versionsResp.ok && versionsResp.data?.versions) {\n    existingLanguages = versionsResp.data.versions.map(v => v.language_code);\n    console.log(`Existing translations: ${existingLanguages.join(', ') || 'none'}`);\n  }\n  \n  // Step 2: Find languages that need translation\n  const languagesToTranslate = languages.filter(lang => !existingLanguages.includes(lang));\n  \n  console.log(`Languages to translate: ${languagesToTranslate.join(', ') || 'none'}`);\n  \n  // Step 3: Download original HTML (needed for new translations)\n  let originalHtml = '';\n  \n  if (languagesToTranslate.length > 0) {\n    // Call prepare-translate with first untranslated language to get download_url\n    const firstUntranslatedLang = languagesToTranslate[0];\n    console.log(`Calling prepare-translate with ${firstUntranslatedLang} to get download URL...`);\n    \n    const prepareResp = await api.frevanaApi.request(\n      'POST',\n      `/s3/content/${contentId}/prepare-translate`,\n      { target_language: firstUntranslatedLang }\n    );\n    \n    if (!prepareResp.ok) {\n      throw new Error(`Failed to prepare translation: ${JSON.stringify(prepareResp.data)}`);\n    }\n    \n    const downloadUrl = prepareResp.data.download_url;\n    if (!downloadUrl) throw new Error('download_url not found in prepare-translate response');\n    \n    // Download original HTML from S3 using download_url from API\n    console.log(`Downloading original HTML from S3...`);\n    const response = await api.fetch(downloadUrl);\n    originalHtml = await response.text();\n    \n    if (!originalHtml) throw new Error('Downloaded content is empty');\n    \n    console.log(`Successfully downloaded ${originalHtml.length} characters`);\n  } else {\n    console.log('All translations already exist, skipping HTML download');\n  }\n  \n  // Return data structure with ALL target languages for loop\n  // The loop will check each language and skip if already exists\n  return JSON.stringify({\n    contentId,\n    languages,\n    originalHtml\n  });\n};",
      "nodeIds": ["content-url-input", "target-languages-input"]
    },
    {
      "id": "extract-languages",
      "nameV2": "Extract Languages",
      "type": "script",
      "outputFormat": "text",
      "script": "module.exports = async function() {\n  const setupData = JSON.parse(data['setup'] || '{}');\n  const languages = setupData.languages || [];\n  \n  if (languages.length === 0) {\n    throw new Error('No languages to translate');\n  }\n  \n  console.log(`Extracted ${languages.length} languages: ${languages.join(', ')}`);\n  return languages.join('\\n');\n};",
      "nodeIds": ["setup"]
    },
    {
      "id": "translate-loop",
      "nameV2": "Translate All",
      "type": "loop",
      "outputFormat": "text",
      "subNodes": [
        {
          "id": "check-prepare",
          "nameV2": "Check & Prepare",
          "type": "script",
          "outputFormat": "text",
          "script": "module.exports = async function() {\n  const setupData = JSON.parse(data['setup'] || '{}');\n  const lang = data['translate-loop-loop'] || '';\n  const contentId = setupData.contentId;\n  const originalHtml = setupData.originalHtml;\n  \n  if (!contentId) throw new Error('Missing content ID');\n  \n  console.log(`[${lang}] Start`);\n  \n  // Initialize global cache for prepared tasks (prevents duplicate prepare calls)\n  if (!globalThis.preparedTasks) {\n    globalThis.preparedTasks = {};\n  }\n  \n  const cacheKey = `${contentId}-${lang}`;\n  \n  // Check if already prepared (idempotency protection)\n  if (globalThis.preparedTasks[cacheKey]) {\n    console.log(`[${lang}] Using cached prepare result`);\n    return JSON.stringify(globalThis.preparedTasks[cacheKey]);\n  }\n  \n  // Check existing translation\n  const versionsResp = await api.frevanaApi.request('GET', `/s3/content/${contentId}/language-versions`);\n  \n  if (versionsResp.ok && versionsResp.data?.versions) {\n    const existing = versionsResp.data.versions.find(v => v.language_code === lang);\n    if (existing) {\n      let url = existing.url || '';\n      if (url && !url.startsWith('http')) url = `https://${url}`;\n      console.log(`[${lang}] Already exists`);\n      const result = { skip: true, lang, status: 'existing', id: existing.content_id, url };\n      globalThis.preparedTasks[cacheKey] = result;\n      return JSON.stringify(result);\n    }\n  }\n  \n  // Prepare new translation\n  console.log(`[${lang}] Calling prepare-translate...`);\n  const prepResp = await api.frevanaApi.request('POST', `/s3/content/${contentId}/prepare-translate`, { target_language: lang });\n  if (!prepResp.ok) throw new Error(`[${lang}] Prepare failed`);\n  \n  console.log(`[${lang}] Prepared (ID: ${prepResp.data.new_content_id})`);\n  \n  const result = {\n    skip: false,\n    lang,\n    html: originalHtml,\n    newId: prepResp.data.new_content_id,\n    uploadUrl: prepResp.data.upload_url\n  };\n  \n  // Cache the result to prevent duplicate prepare calls\n  globalThis.preparedTasks[cacheKey] = result;\n  \n  return JSON.stringify(result);\n};",
          "nodeIds": ["setup", "translate-loop-loop"]
        },
        {
          "id": "translate",
          "nameV2": "Translate",
          "type": "ai_prompt",
          "outputFormat": "text",
          "prompt": "You are a professional HTML translator. Translate the HTML content to the target language.\n\n## INPUT\n\nJSON from previous step:\n@[Substep-1 Check & Prepare](check-prepare)\n\nThe JSON contains either:\n- skip=true: Translation already exists\n- skip=false: Need to translate 'html' to target 'lang'\n\n## INSTRUCTIONS\n\n### If skip is true:\n1. Translation already exists in the system\n2. Return the complete JSON object exactly as received\n3. Do not modify, translate, or process anything\n\n### If skip is false:\n1. Extract the 'html' field from the JSON\n2. Extract the 'lang' field (target language code: zh, ja, es, etc.)\n3. Translate the HTML content to that target language\n4. Return ONLY the translated HTML (no JSON wrapper, no code blocks)\n\n## TRANSLATION RULES (when skip is false)\n\n### PRESERVE (do not change):\n- All HTML tags: <html>, <head>, <body>, <div>, <p>, <h1>, etc.\n- All tag attributes: class, id, style, data-*, etc.\n- All URLs in href and src attributes\n- JavaScript code in <script> tags\n- CSS code in <style> tags\n- Class names and IDs\n- Image sources and media references\n\n### TRANSLATE (change to target language):\n- Text content inside tags: <title>, <h1>-<h6>, <p>, <span>, <div>, <li>, <td>, <button>, <a>\n- Meta tag content attributes: og:title, og:description, twitter:title, twitter:description, description\n- Alt text in <img> tags (alt attribute values)\n- Title attributes (tooltip text)\n- Placeholder text in <input> and <textarea>\n- Aria-label attributes (accessibility text)\n\n### TRANSLATION QUALITY:\n- Use natural, fluent language for the target language\n- Maintain the original tone and style\n- Use appropriate terminology for the target audience\n- Preserve text formatting (bold, italic, etc.)\n- Keep brand names unchanged unless officially translated\n\n## OUTPUT FORMAT\n\n**CRITICAL: Output format depends on skip field:**\n\n### If skip is true:\nReturn the complete JSON object exactly as received.\n\n### If skip is false:\nReturn ONLY the translated HTML with these requirements:\n- NO JSON wrapper\n- NO code blocks (no ```html or ```)\n- NO explanations or comments\n- NO prefix or suffix text\n- Start directly with <!DOCTYPE html> or <html>\n- Maintain proper HTML formatting and structure\n- Ensure valid, well-formed HTML\n\n**GOOD EXAMPLE (skip=false):**\n<!DOCTYPE html>\n<html lang=\"zh\">\n<head>\n  <title>翻译的标题</title>\n</head>\n<body>\n  <h1>翻译的内容</h1>\n</body>\n</html>\n\n**BAD EXAMPLES:**\n```html\n<!DOCTYPE html>...\n```\n\n{\"html\": \"<!DOCTYPE html>...\"}\n\nHere is the translation:\n<!DOCTYPE html>...",
          "model": "gpt-5.1",
          "nodeIds": ["check-prepare"]
        },
        {
          "id": "finish",
          "nameV2": "Finish",
          "type": "script",
          "outputFormat": "text",
          "script": "module.exports = async function() {\n  const prep = JSON.parse(data['check-prepare'] || '{}');\n  const ai = data['translate'] || '';\n  const lang = prep.lang;\n  \n  if (prep.skip) {\n    console.log(`[${lang}] Skip`);\n    return JSON.stringify({ lang, status: 'existing', id: prep.id, url: prep.url });\n  }\n  \n  if (!ai) throw new Error(`[${lang}] No content`);\n  \n  // Upload\n  const up = await api.fetch(prep.uploadUrl, {\n    method: 'PUT',\n    headers: { 'Content-Type': 'text/html' },\n    body: ai\n  });\n  if (up.status !== 200 && up.status !== 204) throw new Error(`[${lang}] Upload failed`);\n  \n  // Extract title\n  const titleMatch = ai.match(/<title[^>]*>([^<]+)<\\/title>/i);\n  const title = titleMatch?.[1]?.trim() || 'Translated';\n  \n  // Confirm\n  const conf = await api.frevanaApi.request('POST', '/s3/content/confirm-translate', { new_content_id: prep.newId, title });\n  if (!conf.ok) throw new Error(`[${lang}] Confirm failed`);\n  \n  let url = conf.data.url || '';\n  if (url && !url.startsWith('http')) url = `https://${url}`;\n  \n  console.log(`[${lang}] Done`);\n  return JSON.stringify({ lang, status: 'new', id: prep.newId, title, url });\n};",
          "nodeIds": ["check-prepare", "translate"]
        }
      ],
      "prompt": "@[Step-2 Extract Languages](extract-languages)",
      "nodeIds": ["extract-languages"]
    },
    {
      "id": "report",
      "nameV2": "Report",
      "type": "script",
      "outputFormat": "text",
      "script": "module.exports = async function() {\n  const results = data['translate-loop'] || '';\n  if (!results) return JSON.stringify({ success: false });\n  \n  let items = [];\n  try {\n    const arr = results.trim().startsWith('[') ? JSON.parse(results) : results.split('\\n').filter(l => l.trim());\n    items = arr.map(item => typeof item === 'string' ? JSON.parse(item) : item);\n  } catch (e) {\n    return JSON.stringify({ success: false, error: e.message });\n  }\n  \n  const newCount = items.filter(i => i.status === 'new').length;\n  const existCount = items.filter(i => i.status === 'existing').length;\n  \n  console.log(`Summary: ${newCount} new, ${existCount} existing`);\n  \n  // Format simple markdown\n  let md = '# Translation Report\\n\\n';\n  md += `**Total:** ${items.length} | **New:** ${newCount} | **Existing:** ${existCount}\\n\\n`;\n  md += '| Language | Status | URL |\\n';\n  md += '|----------|--------|-----|\\n';\n  items.forEach(i => {\n    const urlDisplay = i.url ? `[Link](${i.url})` : 'N/A';\n    md += `| ${i.lang} | ${i.status} | ${urlDisplay} |\\n`;\n  });\n  \n  return md;\n};",
      "nodeIds": ["translate-loop"]
    }
  ],
  "results": [{ "type": "plain_text", "fields": [], "items": { "content": "report" } }],
  "inputValues": {
    "content-url-input": ["https://cookie2-dev.frevana.com/content/en/cursor-vs-qoder-which-ai-coding-companion-delivers-maximum-developer-productivity-in-2025--lydwxrgmr4ccw"],
    "target-languages-input": ["zh, ja"]
  },
  "version": "1.0",
  "metadata": { 
    "author": "Cursor-AI", 
    "createdAt": "2025-12-16T12:30:00.000Z",
    "description": "Ultra-optimized workflow: merged steps, simplified code, ~50% less code"
  },
  "frequency": "-1",
  "mcpConfigs": {},
  "workflowConnects": []
}

